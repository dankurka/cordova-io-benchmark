document.addEventListener("deviceready", function(){
	
	var loadData_4kb = "gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtigwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtigwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtigwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwtiscool!gwti";
	var bench_files = [];
	
	document.getElementById("container").style.display = "block";
	
	var loadFileFromXHR = function(fileUrl, callback){
		var xmlHttp = new XMLHttpRequest();
		xmlHttp.onreadystatechange = function(){
			if (xmlHttp.readyState == 4) {
				callback(xmlHttp.responseText);
			}
		};
		xmlHttp.open("GET", fileUrl, true );
		xmlHttp.send(null );
	};

	
	
	var write = function(txt){
		
		var div = document.createElement("div");
		div.innerText = txt;
		var container = document.getElementById("container").appendChild(div);
		
	};
	
	
	var setup = function(setup_success){
		var fsWriter = function(fileName, number, dataToWrite, success, fail){
			window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function(fs) { 
 				fs.root.getDirectory("/sdcard/tmp/iobench", {create: true, exclusive: false}, function(dir) { 
					dir.getFile(fileName, {create: true, exclusive: false}, function(fileEntry){
						fileEntry.createWriter(function(writer){
							var numberOfTimes = number;
							var f = function(){
								writer.onwriteend = function(evt) {
									numberOfTimes--;
									if(numberOfTimes > 0)
									{
										console.log("numberOfTimes: " + numberOfTimes);
										f();
									}else{
										success(fileEntry);
									}

								};
								writer.write(dataToWrite);
							}
							f();

							}, function(error){
								console.log("can not create writer = " + error);
								fail();
							});
							}, function(error){
								console.log("can not create file = " + error);
								fail();
							});
							}, function(error) { 
			                	console.log("Get Directory Error code = " + error.code);
								fail(); 
							}); 
			        		}, function(error) { 
			            		console.log("Get FS Error code = " + error.code);
								fail(); 
			        		});

		};
		
		(function(data){
			var files = [];
			//got it lets write some files
			write("starting to create 100kb file")
			fsWriter("100kb.txt", 25, loadData_4kb, function(fileEntry){
			write("done!");
			files.push({fileEntry: fileEntry, name : "100kB"});
			write("starting to create 1MB file")
			fsWriter("1MB.txt", 256, loadData_4kb, function(fileEntry){
			write("done!");
			files.push({fileEntry: fileEntry, name : "1MB"});
			setup_success(files);
			});	
			});	
		})();
		
	};

	var loadFileWithFileApi = function(fileEntry, callback){
		fileEntry.file(function(file){
			var reader = new FileReader();
			reader.onloadend = function(evt) {
			            callback(evt.target.result);
			        };
			reader.readAsText(file);
		}, function(){
			alert("error! TODO...");
		});
		
	};
	
	
	var startBenchMark = function(_files){
		
		//deactivate button
		document.getElementById("bench_button").style.display="none";
		
		var files = [];
		for(var i = 0; i < _files.length; i++){
			files.push(_files[i]);
		}
		
		var benchEntry = function(){
			if(files.length > 0){
				var entry = files.shift();			
				var start = new Date().getTime();
				loadFileFromXHR(entry.fileEntry.fullPath, function(txt){
				write(entry.name + " with XHR took: " + (new Date().getTime() - start) +" ms");
				
				start = new Date().getTime();
				loadFileWithFileApi(entry.fileEntry, function(txt){
				write(entry.name + " with FileReader took: " + (new Date().getTime() - start) +" ms");
				benchEntry();
				});
				});
			}else{
				write("bench done!");
				document.getElementById("bench_button").style.display="block";
			}	
		};
		benchEntry();
	};
	
	var bench_files;
	setup(function(files){
		bench_files = files;
		startBenchMark(files);
	});
	
	var button = document.getElementById("bench_button");
	button.addEventListener("click", function(){
		startBenchMark(bench_files);
	});
	
	
});